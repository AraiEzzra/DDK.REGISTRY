"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const type_1 = require("../model/common/transaction/type");
const const_1 = require("../const");
class StakeReward {
    constructor(milestones, distance) {
        this.milestones = milestones;
        this.distance = distance;
    }
    calculateMilestone(height) {
        const location = Math.trunc((height) / this.distance);
        const lastMile = this.milestones[this.milestones.length - 1];
        if (location > (this.milestones.length - 1)) {
            return this.milestones.lastIndexOf(lastMile);
        }
        return location;
    }
    calculateReward(height) {
        return this.milestones[this.calculateMilestone(height)];
    }
}
const stakeReward = new StakeReward(const_1.STAKE.REWARDS.MILESTONES, const_1.STAKE.REWARDS.DISTANCE);
exports.calculateTotalRewardAndUnstake = (createdAt, sender, isDownVote, lastBlockHeight) => {
    let reward = 0;
    let unstake = 0;
    if (isDownVote) {
        return { reward, unstake: unstake };
    }
    sender.stakes
        .filter(stake => stake.isActive && createdAt >= stake.nextVoteMilestone)
        .forEach((stake) => {
        if (stake.voteCount > 0 && (stake.voteCount + 1) % const_1.STAKE.REWARD_VOTE_COUNT === 0) {
            const stakeRewardPercent = stakeReward.calculateReward(lastBlockHeight);
            reward += stake.amount * stakeRewardPercent;
        }
        if (stake.voteCount + 1 === const_1.STAKE.UNSTAKE_VOTE_COUNT) {
            unstake += stake.amount;
        }
    });
    return { reward, unstake };
};
exports.calculateAirdropReward = (sender, amount, transactionType, availableAirdropBalance) => {
    const result = {
        sponsors: new Map(),
    };
    if (!amount) {
        return result;
    }
    if (!sender || !sender.referrals || (sender.referrals.length === 0)) {
        return result;
    }
    const referrals = [];
    if (transactionType === type_1.TransactionType.STAKE) {
        referrals.push(sender.referrals[0]);
    }
    else {
        referrals.push(...sender.referrals);
    }
    let airdropRewardAmount = 0;
    const sponsors = new Map();
    referrals.forEach((sponsor, i) => {
        const reward = transactionType === type_1.TransactionType.STAKE
            ? Math.ceil(amount * const_1.AIRDROP.STAKE_REWARD_PERCENT)
            : Math.ceil(const_1.AIRDROP.REFERRAL_PERCENT_PER_LEVEL[i] * amount);
        sponsors.set(sponsor.address, reward);
        airdropRewardAmount += reward;
    });
    if (availableAirdropBalance < airdropRewardAmount) {
        return result;
    }
    result.sponsors = sponsors;
    return result;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmV3YXJkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWwvcmV3YXJkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsMkRBQW1FO0FBRW5FLG9DQUEwQztBQUcxQyxNQUFNLFdBQVc7SUFJYixZQUFZLFVBQXlCLEVBQUUsUUFBZ0I7UUFDbkQsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7UUFDN0IsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7SUFDN0IsQ0FBQztJQUVELGtCQUFrQixDQUFDLE1BQWM7UUFDN0IsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN0RCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRTdELElBQUksUUFBUSxHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLEVBQUU7WUFDekMsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUNoRDtRQUNELE9BQU8sUUFBUSxDQUFDO0lBQ3BCLENBQUM7SUFFRCxlQUFlLENBQUMsTUFBYztRQUMxQixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFDNUQsQ0FBQztDQUNKO0FBRUQsTUFBTSxXQUFXLEdBQUcsSUFBSSxXQUFXLENBQUMsYUFBSyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsYUFBSyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUV6RSxRQUFBLDhCQUE4QixHQUFHLENBQzFDLFNBQW9CLEVBQ3BCLE1BQWUsRUFDZixVQUFtQixFQUNuQixlQUF1QixFQUNZLEVBQUU7SUFDckMsSUFBSSxNQUFNLEdBQVcsQ0FBQyxDQUFDO0lBQ3ZCLElBQUksT0FBTyxHQUFXLENBQUMsQ0FBQztJQUV4QixJQUFJLFVBQVUsRUFBRTtRQUNaLE9BQU8sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxDQUFDO0tBQ3ZDO0lBRUQsTUFBTSxDQUFDLE1BQU07U0FDUixNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsUUFBUSxJQUFJLFNBQVMsSUFBSSxLQUFLLENBQUMsaUJBQWlCLENBQUM7U0FDdkUsT0FBTyxDQUFDLENBQUMsS0FBa0IsRUFBRSxFQUFFO1FBQzVCLElBQUksS0FBSyxDQUFDLFNBQVMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQyxHQUFHLGFBQUssQ0FBQyxpQkFBaUIsS0FBSyxDQUFDLEVBQUU7WUFDOUUsTUFBTSxrQkFBa0IsR0FBVyxXQUFXLENBQUMsZUFBZSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQ2hGLE1BQU0sSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLGtCQUFrQixDQUFDO1NBQy9DO1FBQ0QsSUFBSSxLQUFLLENBQUMsU0FBUyxHQUFHLENBQUMsS0FBSyxhQUFLLENBQUMsa0JBQWtCLEVBQUU7WUFDbEQsT0FBTyxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUM7U0FDM0I7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVQLE9BQU8sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLENBQUM7QUFDL0IsQ0FBQyxDQUFDO0FBRVcsUUFBQSxzQkFBc0IsR0FBRyxDQUNsQyxNQUFlLEVBQ2YsTUFBYyxFQUNkLGVBQWdDLEVBQ2hDLHVCQUErQixFQUNsQixFQUFFO0lBQ2YsTUFBTSxNQUFNLEdBQWtCO1FBQzFCLFFBQVEsRUFBRSxJQUFJLEdBQUcsRUFBbUI7S0FDdkMsQ0FBQztJQUVGLElBQUksQ0FBQyxNQUFNLEVBQUU7UUFDVCxPQUFPLE1BQU0sQ0FBQztLQUNqQjtJQUVELElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLEVBQUU7UUFDakUsT0FBTyxNQUFNLENBQUM7S0FDakI7SUFFRCxNQUFNLFNBQVMsR0FBRyxFQUFFLENBQUM7SUFDckIsSUFBSSxlQUFlLEtBQUssc0JBQWUsQ0FBQyxLQUFLLEVBQUU7UUFDM0MsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDdkM7U0FBTTtRQUNILFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7S0FDdkM7SUFFRCxJQUFJLG1CQUFtQixHQUFXLENBQUMsQ0FBQztJQUNwQyxNQUFNLFFBQVEsR0FBeUIsSUFBSSxHQUFHLEVBQW1CLENBQUM7SUFFbEUsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQWdCLEVBQUUsQ0FBUyxFQUFFLEVBQUU7UUFDOUMsTUFBTSxNQUFNLEdBQUcsZUFBZSxLQUFLLHNCQUFlLENBQUMsS0FBSztZQUNwRCxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsZUFBTyxDQUFDLG9CQUFvQixDQUFDO1lBQ2xELENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQU8sQ0FBQywwQkFBMEIsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQztRQUNoRSxRQUFRLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDdEMsbUJBQW1CLElBQUksTUFBTSxDQUFDO0lBQ2xDLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSx1QkFBdUIsR0FBRyxtQkFBbUIsRUFBRTtRQUMvQyxPQUFPLE1BQU0sQ0FBQztLQUNqQjtJQUVELE1BQU0sQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0lBRTNCLE9BQU8sTUFBTSxDQUFDO0FBQ2xCLENBQUMsQ0FBQyJ9